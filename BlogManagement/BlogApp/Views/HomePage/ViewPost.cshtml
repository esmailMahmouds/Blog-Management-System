@model BlogApp.Models.DomainClasses.Post

<div class="container my-4">
    <!-- Author Info -->
    <div class="d-flex align-items-center mb-3 p-3 bg-light rounded shadow-sm">
        @if (!string.IsNullOrEmpty(Model.User.ImageURL) || Model.User.ProfileImage != null)
        {
            <img src="@(Model.User.ImageURL ?? $"data:image/png;base64,{Convert.ToBase64String(Model.User.ProfileImage)}")"
                 alt="@Model.User.Name"
                 class="rounded-circle me-3"
                 style="width: 60px; height: 60px; object-fit: cover;">
        }
        else
        {
            <div class="rounded-circle text-white d-flex justify-content-center align-items-center me-3 fw-bold"
                 style="width: 60px; height: 60px; font-size: 1.5rem; background-color: #6c757d;">
                @Model.User.Name[0]
            </div>
        }

        <div>
            <h5 class="mb-0 text-primary fw-bold">@Model.User.Name</h5>
            <small class="text-muted">
                @Model.User.Role.ToString()
                @if (Model.User.Country != null)
                {
                    <span> • @Model.User.Country.Name</span>
                }
            </small>
            <div class="text-muted" style="font-size: 0.85rem;">
                Posted on @Model.CreateDate.ToString("MMMM dd, yyyy")
            </div>
        </div>
    </div>

    <h2 class="text-primary">@Model.Title</h2>
    <p class="text-muted">@Model.Content</p>

    <div class="mb-3">
        <span class="me-3">👍 @Model.LikeCount Likes</span>
        <span>⭐ @Model.AverageRate.ToString("0.0") (@Model.RateCount votes)</span>
    </div>

    <hr />

    <!-- Like -->
    <form asp-action="LikePost" method="post" class="d-inline">
        <input type="hidden" name="postId" value="@Model.Id" />
        <button type="submit" class="btn btn-lg border-0 bg-transparent p-0 text-primary" style="box-shadow: none; outline: none;">
            @if (ViewBag.CurrentUserId != null && Model.Likes.Any(l => l.UserId == ViewBag.CurrentUserId))
            {
                <i class="bi bi-hand-thumbs-up-fill"></i>
            }
            else
            {
                <i class="bi bi-hand-thumbs-up"></i>
            }
        </button>
    </form>

    <!-- Rating -->
    <form asp-action="RatePost" method="post" class="d-inline ms-2">
        <input type="hidden" name="postId" value="@Model.Id" />
        @for (int i = 1; i <= 5; i++)
        {
            bool isFilled = ViewBag.CurrentUserId != null &&
            Model.Ratings.FirstOrDefault(r => r.UserId == ViewBag.CurrentUserId)?.Value >= i;
            <button type="submit" name="rating" value="@i"
                    class="btn btn-link p-0 m-0" style="box-shadow: none; outline: none;">
                <i class="bi @(isFilled ? "bi-star-fill text-warning" : "bi-star text-warning") fs-4"></i>
            </button>
        }
    </form>

    <br /><br />

    <h4>Comments</h4>
    <ul class="list-group mb-3">
        @foreach (var comment in Model.Comments)
        {
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@comment.User.Name:</strong> @comment.Content
                    </div>
                    <div>
                        @if (ViewBag.CurrentUserId == comment.UserId)
                        {
                            <!-- Edit Comment Button -->
                            <button type="button" class="btn btn-warning btn-sm me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editCommentModal-@comment.Id">
                                <i class="bi bi-pencil-square"></i>
                            </button>

                            <!-- Edit Comment -->
                            <div class="modal fade" id="editCommentModal-@comment.Id" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form asp-action="EditComment" method="post">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Edit Comment</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="hidden" name="id" value="@comment.Id" />
                                                <input type="hidden" name="postId" value="@Model.Id" />
                                                <textarea name="content" class="form-control" required>@comment.Content</textarea>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary">Save changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (ViewBag.CurrentUserId == comment.UserId || User.IsInRole("Admin"))
                        {
                            <!-- Delete -->
                            <form asp-action="DeleteComment" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@comment.Id" />
                                <input type="hidden" name="postId" value="@Model.Id" />
                                <button type="submit" class="btn btn-danger btn-sm"
                                        onclick="return confirm('Are you sure you want to delete this comment?');">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </form>

                        }
                    </div>
                </div>
            </li>
        }

    </ul>

    <!-- Add Comment -->
    <form asp-action="AddComment" method="post">
        <input type="hidden" name="postId" value="@Model.Id" />
        <textarea name="content" class="form-control mb-2" placeholder="Add a comment..." required></textarea>
        <button type="submit" class="btn btn-primary btn-sm">Comment</button>
    </form>
</div>
